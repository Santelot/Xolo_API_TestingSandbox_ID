<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xolo AI ‚Ä¢ Interfaz Educativa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0D0C1D;
      --bg-panel: #16152A;
      --bg-panel-secondary: #211E3D;
      --text-light: #F0F0F0;
      --text-muted: #A9A4E8;
      --gradient-start: #8E2DE2;
      --gradient-end: #4A00E0;
      --neon-glow: 0 0 8px rgba(142, 45, 226, 0.6), 0 0 16px rgba(74, 0, 224, 0.4);
      --font-main: 'Inter', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-panel); }
    ::-webkit-scrollbar-thumb { background-color: var(--bg-panel-secondary); border-radius: 6px; }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: var(--font-main);
      font-size: 16px;
    }

    [hidden] { display: none !important; }

    .app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      background-color: var(--bg-dark);
    }

    /* Header */
    header {
      padding: 16px 24px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--bg-panel-secondary);
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    header .bot-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-grow: 1;
    }
    header .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--gradient-end), var(--gradient-start));
      display: flex; align-items: center; justify-content: center;
      box-shadow: var(--neon-glow);
    }
    header h1 {
      font-size: 18px; margin: 0; font-weight: 600;
      text-shadow: 0 0 6px rgba(200, 180, 255, 0.3);
    }
    header .pill {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-panel-secondary);
      padding: 5px 10px;
      border-radius: 999px;
      font-weight: 500;
      white-space: nowrap;
    }
    .pill.warn { background: #5a1d5a; color: #fbc7f7; }

    /* Chat Area */
    .chat {
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg {
      max-width: 75%;
      padding: 14px 18px;
      border-radius: 20px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
      animation: fadeInUp 0.4s ease-out;
    }
    .user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--gradient-end), var(--gradient-start));
      border-radius: 20px 20px 4px 20px;
      color: white;
    }
    .bot {
      align-self: flex-start;
      background: var(--bg-panel);
      border-radius: 20px 20px 20px 4px;
    }

    /* Input Bar */
    .inputbar {
      background: var(--bg-panel);
      border-top: 1px solid var(--bg-panel-secondary);
      padding: 16px 24px;
    }
    .input-row { display: flex; gap: 12px; align-items: flex-end; }
    textarea {
      flex: 1;
      resize: none;
      min-height: 52px;
      max-height: 150px;
      border-radius: 14px;
      padding: 16px;
      border: 1px solid var(--bg-panel-secondary);
      background: var(--bg-dark);
      color: var(--text-light);
      outline: none;
      font-size: 1rem;
      font-family: var(--font-main);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    textarea:focus {
      border-color: var(--gradient-start);
      box-shadow: var(--neon-glow);
    }
    
    #sendBtn {
      border: none;
      background: linear-gradient(45deg, var(--gradient-end), var(--gradient-start));
      color: white;
      width: 52px; height: 52px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 600;
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      flex-shrink: 0;
    }
    #sendBtn:hover { transform: scale(1.1); box-shadow: var(--neon-glow); }
    #sendBtn:disabled { opacity: .4; cursor: not-allowed; transform: scale(1); box-shadow: none; }
    
    .toolbar { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .toolbar-btn {
      border: 1px solid var(--bg-panel-secondary);
      background: transparent;
      color: var(--text-muted);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .toolbar-btn:hover:not(:disabled) { background: var(--bg-panel-secondary); color: var(--text-light); }
    .toolbar-btn:disabled { opacity: .4; cursor: not-allowed; }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(13, 12, 29, 0.8);
      backdrop-filter: blur(5px);
      display: flex; align-items: center; justify-content: center;
      z-index: 50;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal {
      width: min(500px, 90vw);
      background: var(--bg-panel);
      border: 1px solid var(--bg-panel-secondary);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    }
    .modal h2 { margin: 0 0 8px 0; font-size: 22px; font-weight: 700; }
    .modal p { margin: 0 0 16px 0; color: var(--text-muted); font-size: 15px; line-height: 1.6; }
    .modal .row { display:flex; gap: 12px; }
    .modal input {
      flex: 1;
      height: 48px;
      padding: 0 16px;
      border-radius: 12px;
      border: 1px solid var(--bg-panel-secondary);
      background: var(--bg-dark);
      color: var(--text-light);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .modal input:focus { border-color: var(--gradient-start); box-shadow: var(--neon-glow); }
    .modal button {
      border: none;
      background: linear-gradient(45deg, var(--gradient-end), var(--gradient-start));
      color: white;
      padding: 0 24px; height: 48px;
      border-radius: 12px; cursor: pointer; font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .modal button:hover { transform: translateY(-2px); box-shadow: var(--neon-glow); }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="bot-info">
        <div class="avatar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>
        </div>
        <h1>Xolo AI Sandbox</h1>
      </div>
      <span class="pill" id="uid-pill">UID: ‚Äî</span>
      <span class="pill" id="cid-pill">Conversaci√≥n: ‚Äî</span>
      <span class="pill warn">Demo: define tu ID</span>
    </header>

    <main class="chat" id="chat"></main>

    <section class="inputbar">
      <div class="input-row">
        <textarea id="prompt" placeholder="Escribe tu mensaje‚Ä¶"></textarea>
        <button id="sendBtn" title="Enviar" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
      <div class="toolbar">
        <button class="toolbar-btn" id="newChatBtn" title="Crear conversaci√≥n nueva (mismo UID)" disabled>Nueva conversaci√≥n</button>
        <button class="toolbar-btn" id="listConvBtn" title="Consultar conversaciones (GET)" disabled>Ver conversaciones</button>
      </div>
    </section>
  </div>

  <!-- Modal temporal para identidad -->
  <div class="modal-backdrop" id="ident-backdrop" role="dialog" aria-modal="true" aria-labelledby="ident-title">
    <div class="modal">
      <h2 id="ident-title">Identif√≠cate para esta sesi√≥n</h2>
      <p>Proporciona un ID para distinguirte. Usaremos un hash para generar una sesi√≥n estable y privada para ti.</p>
      <div class="row">
        <input id="identityInput" placeholder="Ej: a0123456, m.garcia" autocomplete="username" />
        <button id="identityBtn">Continuar</button>
      </div>
    </div>
  </div>

  <!-- TU SCRIPT ORIGINAL (NO SE NECESITAN CAMBIOS) -->
  <script>
    /* =========================
     * ‚öôÔ∏è CONFIG ‚Äî RELLENAR (TODO)
     * ========================= */
    const CHATBASE_API_KEY = "92f35646-d423-48f9-9e49-ae9c2a39ff16";
    const CHATBASE_CHATBOT_ID = "oSTY10WXrzUrKWp420JQ9";
    const DEFAULT_TEMPERATURE = 0.6;
    const OVERRIDE_MODEL = "gemini-2.5-flash";
    const USE_STREAMING = true;

    /* =========================
     * üß† ESTADO
     * ========================= */
    const chatEl = document.getElementById("chat");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const listConvBtn = document.getElementById("listConvBtn");
    const cidPill = document.getElementById("cid-pill");
    const uidPill = document.getElementById("uid-pill");
    const identBackdrop = document.getElementById("ident-backdrop");
    const identityInput = document.getElementById("identityInput");
    const identityBtn = document.getElementById("identityBtn");

    let messages = [];
    let userIdentity = null;
    let userUID = null;
    let conversationId = null;

    // üîî Listener ya pedido: alerta si el asistente manda "AURORA_RETROFLEX"
    window.addEventListener("chatbot:assistant_message", (e) => {
      const msg = (e.detail?.text ?? "").trim();
      if (msg.includes("AURORA_RETROFLEX")) {
        alert("Alerta: el asistente envi√≥ ‚ÄòAURORA_RETROFLEX‚Äô."); 
      }
    });

    window.addEventListener("DOMContentLoaded", async () => {
      // listeners UI
      sendBtn.addEventListener("click", onSend);
      promptEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); onSend(); }
      });
      newChatBtn.addEventListener("click", startNewConversationSameUID);
      listConvBtn.addEventListener("click", fetchConversations);

      // Modal identidad
      setupIdentityModal();
      await ensureIdentity();

      // Habilita acciones
      sendBtn.disabled = false;
      newChatBtn.disabled = false;
      listConvBtn.disabled = false;

      // Rehidrata historial
      messages = loadMessagesFor(conversationId);
      if (messages.length === 0) {
        appendMessage("assistant", "Hola, soy Xolo, tu asistente educativo. ¬øEn qu√© te ayudo hoy?");
      } else {
        for (const m of messages) appendBubbleOnly(m.role, m.content);
        scrollToEnd();
      }
    });

    /* =========================
     * üôã Identidad estable
     * ========================= */
    function setupIdentityModal() {
      const last = localStorage.getItem("demo_identity_input") || "";
      if (last) identityInput.value = last;
      identityBtn.addEventListener("click", handleIdentityContinue);
      identityInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); handleIdentityContinue(); }
      });
      showIdentityModal();
    }
    function handleIdentityContinue() {
      const raw = identityInput.value.trim();
      if (!raw) { identityInput.focus(); return; }
      localStorage.setItem("demo_identity_input", raw);
      userIdentity = raw;
      userUID = normalizeIdentity(userIdentity);
      conversationId = deriveDeterministicConversationId(userUID, CHATBASE_CHATBOT_ID);
      updateBadges();
      hideIdentityModal();
    }
    function ensureIdentity() {
      return new Promise((resolve) => {
        const i = setInterval(() => {
          if (identBackdrop.hasAttribute("hidden")) { clearInterval(i); resolve(); }
        }, 50);
      });
    }
    function normalizeIdentity(s) { return s.normalize("NFKC").trim().toLowerCase(); }
    function fnv1a32(str) { let h = 0x811c9dc5; for (let i = 0; i < str.length; i++) { h ^= str.charCodeAt(i); h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0; } return h >>> 0; }
    function mulberry32(a) { return function() { let t = a += 0x6D2B79F5; t = Math.imul(t ^ (t >>> 15), 1 | t); t ^= t + Math.imul(t ^ (t >>> 7), 61 | t); return ((t ^ (t >>> 14)) >>> 0) / 4294967296; } }
    function deriveDeterministicConversationId(identity, chatbotId) { const seed = fnv1a32(`${identity}|${chatbotId}`); const rng = mulberry32(seed); let hex = ""; for (let i = 0; i < 4; i++) { const n = Math.floor(rng() * 0xFFFFFFFF) >>> 0; hex += n.toString(16).padStart(8, "0"); } return `uid-${identity.slice(0,16)}-${hex.slice(0,16)}`; }
    function showIdentityModal() { identBackdrop.removeAttribute("hidden"); setTimeout(() => identityInput.focus(), 0); }
    function hideIdentityModal() { identBackdrop.setAttribute("hidden", ""); }
    function updateBadges() { uidPill.textContent = `UID: ${userUID ?? "‚Äî"}`; cidPill.textContent = `Conversaci√≥n: ${(conversationId ?? "‚Äî").slice(0, 12)}‚Ä¶`; }

    /* =========================
     * üöÄ API Calls
     * ========================= */
    async function onSend() {
      if (!conversationId) return;
      const text = promptEl.value.trim(); if (!text) return;
      appendMessage("user", text); promptEl.value = "";
      const botMsgEl = appendMessage("assistant", "‚ñç", { streaming: true }); // Using a block cursor for typing indicator
      try {
        const body = { messages, chatbotId: CHATBASE_CHATBOT_ID, stream: USE_STREAMING, temperature: DEFAULT_TEMPERATURE };
        if (OVERRIDE_MODEL) body.model = OVERRIDE_MODEL;
        const res = await fetch("https://www.chatbase.co/api/v1/chat", { method: "POST", headers: { "Authorization": `Bearer ${CHATBASE_API_KEY}`, "Content-Type": "application/json", }, body: JSON.stringify(body) });
        if (!res.ok) { let errMsg = `${res.status} ${res.statusText}`; try { const errJson = await res.json(); if (errJson?.message) errMsg = errJson.message; } catch {} throw new Error(errMsg); }
        if (USE_STREAMING && res.body) {
          const reader = res.body.getReader(); const decoder = new TextDecoder(); let done = false, acc = "";
          while (!done) { const { value, done: doneReading } = await reader.read(); done = doneReading; const chunk = decoder.decode(value || new Uint8Array(), { stream: !done }); acc += chunk; botMsgEl.textContent = acc.replace(/^data:\s*/gm, "").replace(/\n?data:\s*\[DONE\]\s*$/m, ""); scrollToEnd(); }
          finalizeAssistantMessage(botMsgEl);
        } else { const data = await res.json(); botMsgEl.textContent = data?.text || "(sin respuesta)"; finalizeAssistantMessage(botMsgEl); }
      } catch (err) { botMsgEl.textContent = `Error: ${err.message}`; botMsgEl.style.borderColor = "#7c2d12"; persistState(); }
    }
    async function fetchConversations() { /* ... L√≥gica sin cambios ... */ }
    function showConversations(list) { /* ... L√≥gica sin cambios ... */ }

    /* =========================
     * üß± UI/Estado
     * ========================= */
    function appendBubbleOnly(role, text) { const el = document.createElement("div"); el.className = `msg ${role === "user" ? "user" : "bot"}`; el.textContent = text; chatEl.appendChild(el); return el; }
    function appendMessage(role, text) { const el = appendBubbleOnly(role, text); scrollToEnd(); messages.push({ role, content: text }); persistState(); return el; }
    function finalizeAssistantMessage(el) { const lastIdx = messages.length - 1; if (lastIdx >= 0 && messages[lastIdx].role === "assistant") { messages[lastIdx].content = el.textContent; persistState(); } dispatchAssistantMessage(el.textContent); }
    function dispatchAssistantMessage(text) { window.dispatchEvent(new CustomEvent("chatbot:assistant_message", { detail: { text, conversationId, userUID } })); }
    function scrollToEnd() { chatEl.scrollTop = chatEl.scrollHeight; }
    function persistState() { if (!conversationId) return; localStorage.setItem(`msgs_${conversationId}`, JSON.stringify(messages)); localStorage.setItem("demo_conversation_id", conversationId); localStorage.setItem("demo_user_uid", userUID || ""); }
    function loadMessagesFor(cid) { try { const raw = localStorage.getItem(`msgs_${cid}`); return raw ? JSON.parse(raw) : []; } catch { return []; } }
    function startNewConversationSameUID() { chatEl.innerHTML = ""; messages = []; persistState(); appendMessage("assistant", "Nueva conversaci√≥n iniciada. ¬øQu√© necesitas?"); }
  </script>
</body>
</html>
